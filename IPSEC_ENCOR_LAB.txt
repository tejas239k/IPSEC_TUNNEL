R6
enable
configure terminal
hostname R6
interface e0/0
no switchport
ip address 146.1.1.6 255.255.255.0
no shutdown
exit
interface loopback 0
ip address 6.6.6.6 255.0.0.0
exit
ip route 0.0.0.0 0.0.0.0 146.1.1.4

sw4
enable
configure terminal
hostname sw4
interface e0/1
no switchport
ip address 146.1.1.4 255.255.255.0
no shutdown
exit
interface e0/0
no switchport
ip address 45.1.1.4 255.255.255.0
no shutdown
exit
ip route 157.1.1.0 255.255.255.0 45.1.1.5

sw5
enable
configure terminal
hostname sw5
interface e0/1
no switchport
ip address 157.1.1.5 255.255.255.0
no shutdown
exit
interface e0/0
no switchport
ip address 45.1.1.5 255.255.255.0
no shutdown
exit
ip route 146.1.1.0 255.255.255.0 45.1.1.4

R7
enable
configure terminal
hostname R7
interface e0/0
no switchport
ip address 157.1.1.7 255.255.255.0
no shutdown
exit
interface loopback 0
ip address 7.7.7.7 255.0.0.0
exit
ip route 0.0.0.0 0.0.0.0 157.1.1.5
___________________________________________________________

IPSEC TUNNELS PHASES

R6
Phase 1 config
crypto isakmp policy 5
 encr 3des
 hash md5
 authentication pre-share
 group 2
exit
crypto isakmp key cisco123 address 157.1.1.7

Phase 2 config
crypto ipsec transform-set TSET esp-3des esp-sha-hmac
exit
access-list 101 permit ip 6.6.6.6 0.255.255.255 7.7.7.7 0.255.255.255
crypto map CMAP 10 ipsec-isakmp
match address 101 
 set peer 157.1.1.7
 set transform-set TSET 
 exit
interface e0/0
crypto map CMAP
exit

R7
Phase 1 config
crypto isakmp policy 5
 encr 3des
 hash md5
 authentication pre-share
 group 2
exit
crypto isakmp key cisco123 address 146.1.1.6

Phase 2 config
crypto ipsec transform-set TSET esp-3des esp-sha-hmac
exit

access-list 101 permit ip 7.7.7.7 0.255.255.255 6.6.6.6 0.255.255.255
crypto map CMAP 10 ipsec-isakmp 
match address 101
 set peer 146.1.1.6
 set transform-set TSET 
 exit
interface e0/0
crypto map CMAP
exit

Verification:
R6#ping 7.7.7.7 source 6.6.6.6
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 7.7.7.7, timeout is 2 seconds:
Packet sent with a source address of 6.6.6.6 
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 5/5/7 ms

R6#show crypto isakmp sa
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
157.1.1.7       146.1.1.6       QM_IDLE           1001 ACTIVE

_____________________________________________________________

GRE OVER IPSEC(Tunnel Mode)

R6
interface tunnel 1
 no shut
tunnel source 146.1.1.6
tunnel destination 157.1.1.7
ip address 192.168.1.6 255.255.255.0
!
router eigrp 1
network 6.0.0.0 0.255.255.255

R7
interface tunnel 1
 no shut
tunnel source 157.1.1.7
tunnel destination 146.1.1.6
ip address 192.168.1.7 255.255.255.0
!
router eigrp 1
network 7.0.0.0 0.255.255.255


EIGRP HELLO Packet = 98 bytes

----------------------------------------------------------------------
| 195.1.1.1 | 205.1.1.4 | GRE | 192.168.1.1 | 224.0.0.10 | EIGRP Data
----------------------------------------------------------------------

IPSEC to secure the tunnel using IPSEC profile Method:

R6
!1. Configure the parameters for phase-1

crypto isakmp policy 5
 encr 3des
 hash md5
 authentication pre-share
 group 2
exit
crypto isakmp key cisco123 address 157.1.1.7

!2. Configure the parameters for phase-2
crypto ipsec transform-set TSET esp-3des esp-sha-hmac
exit

!3. Configure an IPSEC profile to attach the transform-set
crypto IPsec profile IPSECPROFILE
set transform-set TSET

!4. Configure the tunnel interface to encrypt all traffic
interface tunnel 1
tunnel protection IPsec profile IPSECPROFILE

R7
!1. Configure the parameters for phase-1

crypto isakmp policy 5
 encr 3des
 hash md5
 authentication pre-share
 group 2
exit
crypto isakmp key cisco123 address 146.1.1.6

!2. Configure the parameters for phase-2
crypto ipsec transform-set TSET esp-3des esp-sha-hmac
exit

!3. Configure an IPSEC profile to attach the transform-set
crypto IPsec profile IPSECPROFILE
set transform-set TSET

!4. Configure the tunnel interface to encrypt all traffic
interface tunnel 1
tunnel protection IPsec profile IPSECPROFILE


Verification:
R6#traceroute 7.7.7.7    
Type escape sequence to abort.
Tracing the route to 7.7.7.7
VRF info: (vrf in name/id, vrf out name/id)
  1 192.168.1.7 7 msec 2 msec *


EIGRP HELLO Packet = 150 bytes

----------------------------------------------------------------------------------------------------
|195.1.1.1 | 205.1.1.4 | ESP | 195.1.1.1 | 205.1.1.4 | GRE | 192.168.1.1 | 224.0.0.10 | EIGRP Data
----------------------------------------------------------------------------------------------------

So, In normal tunnel mode 52 bytes extra header is increased.

____________________________________________________________


GRE OVER IPSEC(Transport Mode)


- In transport mode, IPSEC will look into inner header
- If it finds any duplication of the IP header, then it removes the IP header from the inner header and hence reduce the overall packet size
- If it doesn't find any duplication, it reverts back to normal mode.

R6-R7

crypto ipsec transform-set TSET esp-3des esp-sha-hmac 
mode transport

clear crypto sa

EIGRP HELLO Packet = 134 bytes

--------------------------------------------------------------------------
|195.1.1.1 | 205.1.1.4 | ESP | GRE | 192.168.1.1 | 224.0.0.10 | EIGRP Data
---------------------------------------------------------------------------

it is still the GRE packet


R6#show crypto ipsec sa

interface: Tunnel1
    Crypto map tag: Tunnel1-head-0, local addr 146.1.1.6

   protected vrf: (none)
   local  ident (addr/mask/prot/port): (146.1.1.6/255.255.255.255/47/0)
   remote ident (addr/mask/prot/port): (157.1.1.7/255.255.255.255/47/0)
   current_peer 157.1.1.7 port 500
     PERMIT, flags={origin_is_acl,}
    #pkts encaps: 15, #pkts encrypt: 15, #pkts digest: 15
    #pkts decaps: 15, #pkts decrypt: 15, #pkts verify: 15
    #pkts compressed: 0, #pkts decompressed: 0
    #pkts not compressed: 0, #pkts compr. failed: 0
    #pkts not decompressed: 0, #pkts decompress failed: 0
    #send errors 0, #recv errors 0

     local crypto endpt.: 146.1.1.6, remote crypto endpt.: 157.1.1.7
     plaintext mtu 1466, path mtu 1500, ip mtu 1500, ip mtu idb Ethernet0/0
     current outbound spi: 0x6083F9E6(1619261926)
     PFS (Y/N): N, DH group: none

     inbound esp sas:
      spi: 0xB641E071(3057770609)
        transform: esp-3des esp-sha-hmac ,
        in use settings ={Transport, } 
        conn id: 9, flow_id: 9, sibling_flags 80000000, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4321461/3590)
        IV size: 8 bytes
        replay detection support: Y
        Status: ACTIVE(ACTIVE)
          
     inbound ah sas:
          
     inbound pcp sas:
          
     outbound esp sas:
      spi: 0x6083F9E6(1619261926)
        transform: esp-3des esp-sha-hmac ,
        in use settings ={Transport, } <-------- Transport Mode
        conn id: 10, flow_id: 10, sibling_flags 80000000, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4321461/3590)
        IV size: 8 bytes
        replay detection support: Y
        Status: ACTIVE(ACTIVE)
          
     outbound ah sas:
          
     outbound pcp sas:

_________________________________________________________

S-VTI (Static Virtual Tunnel Interface)

- It changes the tunnel protocol from GRE to native IPSEC
- This eliminates the GRE Header/protocol from the packet

This GRE header in the tunnel is of 8 bytes and we can remove this as well.

*Before S-VTI

R6#show int tu1 
Tunnel1 is up, line protocol is up 
  Hardware is Tunnel
  Internet address is 192.168.1.6/24
  MTU 17882 bytes, BW 100 Kbit/sec, DLY 50000 usec, 
     reliability 255/255, txload 1/255, rxload 1/255
  Encapsulation TUNNEL, loopback not set
  Keepalive not set
  Tunnel linestate evaluation up
  Tunnel source 146.1.1.6, destination 157.1.1.7
  Tunnel protocol/transport GRE/IP <---- GRE OVER IP
    Key disabled, sequencing disabled
    Checksumming of packets disabled
  Tunnel TTL 255, Fast tunneling enabled
  Tunnel transport MTU 1442 bytes
  Tunnel transmit bandwidth 8000 (kbps)
  Tunnel receive bandwidth 8000 (kbps)
  Tunnel protection via IPSec (profile "IPSECPROFILE")
  Last input 00:00:02, output never, output hang never
  Last clearing of "show interface" counters 00:39:55
  Input queue: 0/75/0/0 (size/max/drops/flushes); Total output drops: 0
  Queueing strategy: fifo
  Output queue: 0/0 (size/max)
  5 minute input rate 0 bits/sec, 0 packets/sec
  5 minute output rate 0 bits/sec, 0 packets/sec
     406 packets input, 34372 bytes, 0 no buffer
     Received 0 broadcasts (0 IP multicasts)
     0 runts, 0 giants, 0 throttles 
     0 input errors, 0 CRC, 0 frame, 0 overrun, 0 ignored, 0 abort
     416 packets output, 35102 bytes, 0 underruns
     0 output errors, 0 collisions, 0 interface resets
     0 unknown protocol drops
     0 output buffer failures, 0 output buffers swapped out


R6/R7:

interface tunnel 1
 tunnel mode IPsec ipv4


*After S-VTI

R6#show interfaces tun1
Tunnel1 is up, line protocol is up 
  Hardware is Tunnel
  Internet address is 192.168.1.6/24
  MTU 17886 bytes, BW 100 Kbit/sec, DLY 50000 usec, 
     reliability 255/255, txload 1/255, rxload 1/255
  Encapsulation TUNNEL, loopback not set
  Keepalive not set
  Tunnel linestate evaluation up
  Tunnel source 146.1.1.6, destination 157.1.1.7
  Tunnel protocol/transport IPSEC/IP <----- Native IPSEC
  Tunnel TTL 255
  Tunnel transport MTU 1446 bytes
  Tunnel transmit bandwidth 8000 (kbps)
  Tunnel receive bandwidth 8000 (kbps)
  Tunnel protection via IPSec (profile "IPSECPROFILE")
  Last input 00:04:10, output never, output hang never
  Last clearing of "show interface" counters 00:47:08
  Input queue: 0/75/0/0 (size/max/drops/flushes); Total output drops: 15
  Queueing strategy: fifo
  Output queue: 0/0 (size/max)
  5 minute input rate 0 bits/sec, 0 packets/sec
  5 minute output rate 0 bits/sec, 0 packets/sec
     503 packets input, 41536 bytes, 0 no buffer
     Received 0 broadcasts (0 IP multicasts)
     0 runts, 0 giants, 0 throttles 
     0 input errors, 0 CRC, 0 frame, 0 overrun, 0 ignored, 0 abort
     513 packets output, 41926 bytes, 0 underruns
     0 output errors, 0 collisions, 0 interface resets
     0 unknown protocol drops
     0 output buffer failures, 0 output buffers swapped out


EIGRP HELLO Packet = 126 bytes

----------------------------------------------------------------------
|195.1.1.1 | 205.1.1.4 | ESP | 192.168.1.1 | 224.0.0.10 | EIGRP Data |
----------------------------------------------------------------------

The GRE header in the tunnel was of 8 bytes and we just removed it!!



